<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BOT â€“ Admin Spin Wheel</title>
  <link rel="stylesheet" href="admin.css"/>
</head>
<body>
<header>
  <h1>Admin Spin Wheel</h1>
  <div>
    <label>Admin API Key <input id="apiKey" type="password" placeholder="x-admin-key"/></label>
    <button id="refresh">Refresh</button>
  </div>
</header>
<main>
  <section class="panel">
    <h2>Wheels</h2>
    <div id="wheels"></div>
    <h3>Buat Wheel</h3>
    <form id="createWheel">
      <input name="id" placeholder="wheel_daily" required/>
      <input name="name" placeholder="Nama Wheel" required/>
      <input name="global_daily_cap" type="number" placeholder="Global Daily Cap" value="600"/>
      <input name="fallback" placeholder="Fallback (ZONK)" value="ZONK"/>
      <button type="submit">Create</button>
    </form>
  </section>
  <section class="panel">
    <h2>Slices (Wheel terpilih)</h2>
    <div>
      <label>Wheel ID <input id="wheelId" value="wheel_daily"/></label>
      <button id="loadSlices">Load</button>
    </div>
    <table id="sliceTable">
      <thead>
        <tr><th>Pos</th><th>ID</th><th>Label</th><th>Type</th><th>Weight</th><th>Cap/Hari</th><th>Max/User</th><th>Aksi</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Tambah/Update Slice</h3>
    <form id="upsertSlice">
      <input name="id" placeholder="ID (unik)" required/>
      <input name="label" placeholder="Label" required/>
      <select name="type">
        <option>voucher</option>
        <option>cashback</option>
        <option>points</option>
        <option>ticket</option>
        <option>mystery</option>
        <option>none</option>
        <option>none_soft</option>
      </select>
      <input name="weight" type="number" step="0.001" placeholder="Weight" required/>
      <input name="daily_cap" type="number" placeholder="Daily Cap"/>
      <input name="max_per_user_per_day" type="number" placeholder="Max/User/Day"/>
      <input name="bg" placeholder="BG #hex" value="#0B61A4"/>
      <input name="fg" placeholder="FG #hex" value="#FFFFFF"/>
      <input name="position_index" type="number" placeholder="Pos" value="0"/>
      <textarea name="metadata" placeholder='{"discount_percent":10,"code_prefix":"BOT10"}'></textarea>
      <button type="submit">Upsert</button>
    </form>
  </section>
</main>
<script>
const API = location.origin.replace(/\/$/, '')
const $ = sel => document.querySelector(sel);
const wheelsDiv = $('#wheels');
const sliceTBody = $('#sliceTable tbody');

function keyHeader(){ return { 'x-admin-key': $('#apiKey').value||'' , 'Content-Type':'application/json' } }

async function loadWheels(){
  const r = await fetch(API+'/admin/wheels',{headers:keyHeader()});
  const data = await r.json();
  wheelsDiv.innerHTML = '<pre>'+JSON.stringify(data,null,2)+'</pre>';
}

$('#refresh').onclick = loadWheels;
$('#createWheel').onsubmit = async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = Object.fromEntries(fd.entries());
  payload.global_daily_cap = Number(payload.global_daily_cap||600);
  const r = await fetch(API+'/admin/wheels',{method:'POST',headers:keyHeader(),body:JSON.stringify(payload)});
  alert('Created: '+r.status);
  loadWheels();
}

$('#loadSlices').onclick = async ()=>{
  const id = $('#wheelId').value;
  const r = await fetch(API+`/admin/wheels/${id}/slices`,{headers:keyHeader()});
  const rows = await r.json();
  sliceTBody.innerHTML = '';
  rows.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.position_index??''}</td><td>${s.id}</td><td>${s.label}</td><td>${s.type}</td><td>${s.weight}</td><td>${s.daily_cap??''}</td><td>${s.max_per_user_per_day??''}</td><td><button data-del='${s.id}'>Hapus</button></td>`;
    sliceTBody.appendChild(tr);
  });
  sliceTBody.onclick = async (e)=>{
    const id = e.target?.dataset?.del; if(!id) return;
    if(!confirm('Hapus slice '+id+' ?')) return;
    const r = await fetch(API+`/admin/wheels/${$('#wheelId').value}/slices/${id}`,{method:'DELETE',headers:keyHeader()});
    alert('Deleted: '+r.status);
    $('#loadSlices').click();
  }
}

$('#upsertSlice').onsubmit = async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const wheelId = $('#wheelId').value;
  const payload = {
    id: fd.get('id'),
    label: fd.get('label'),
    type: fd.get('type'),
    weight: Number(fd.get('weight')),
    daily_cap: fd.get('daily_cap')? Number(fd.get('daily_cap')): null,
    max_per_user_per_day: fd.get('max_per_user_per_day')? Number(fd.get('max_per_user_per_day')): null,
    metadata: fd.get('metadata')? JSON.parse(fd.get('metadata')): {},
    style: { bg: fd.get('bg'), fg: fd.get('fg') },
    position_index: Number(fd.get('position_index')||0)
  };
  // try PUT (update), if 404 then POST (create)
  let r = await fetch(API+`/admin/wheels/${wheelId}/slices/${payload.id}`,{method:'PUT',headers:keyHeader(),body:JSON.stringify(payload)});
  if (r.status===404) {
    r = await fetch(API+`/admin/wheels/${wheelId}/slices`,{method:'POST',headers:keyHeader(),body:JSON.stringify(payload)});
  }
  alert('Upsert status: '+r.status);
  $('#loadSlices').click();
}

loadWheels();
</script>
</body>
</html>
